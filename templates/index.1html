<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSM Designer | State Machine Generator</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%2310b981'/><path d='M30 50 L50 30 L70 50 L50 70 Z' fill='white'/></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #0ea5e9;
            --accent: #f59e0b;
            --bg-main: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: #cbd5e1;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #dbeafe 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Topbar Navigation */
        .topbar {
            background: var(--bg-main);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
        }

        .logo-text {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Main Layout - Sidebar + Content */
        .main-wrapper {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2rem;
            min-height: calc(100vh - 120px);
            flex: 1;
        }

        /* Sidebar Panel */
        .sidebar {
            background: var(--bg-main);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--bg-secondary);
        }

        .sidebar-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-icon svg {
            width: 18px;
            height: 18px;
            stroke: white;
        }

        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        textarea {
            width: 100%;
            min-height: 140px;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
            color: var(--text-primary);
            background: var(--bg-secondary);
            resize: vertical;
            transition: all 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-main);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        textarea::placeholder {
            color: var(--text-muted);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn svg {
            width: 18px;
            height: 18px;
        }

        /* Examples Section */
        .examples-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--bg-secondary);
        }

        .examples-header {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .example-chips {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .example-chip {
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .example-chip:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: translateX(4px);
            box-shadow: var(--shadow);
        }

        /* Content Area */
        .content-area {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Info Banner */
        .info-banner {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            padding: 2rem;
            color: white;
            box-shadow: var(--shadow);
        }

        .banner-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .banner-subtitle {
            font-size: 1.125rem;
            opacity: 0.95;
        }

        /* Output Card */
        .output-card {
            background: var(--bg-main);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--bg-secondary);
        }

        .output-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .output-title svg {
            width: 24px;
            height: 24px;
            stroke: var(--primary);
        }

        .output-body {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .placeholder {
            text-align: center;
            color: var(--text-muted);
        }

        .placeholder-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 1.5rem;
            opacity: 0.3;
        }

        .placeholder-text {
            font-size: 1.125rem;
            font-weight: 500;
        }

        #diagramContainer {
            width: 100%;
            height: 100%;
            display: none;
        }

        #diagramContainer.show {
            display: block;
        }

        #diagram {
            width: 100%;
            height: 100%;
            min-height: 550px;
        }

        /* FSM Diagram Styles */
        .state-node {
            fill: white;
            stroke: var(--primary);
            stroke-width: 3;
            cursor: pointer;
            transition: all 0.3s;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .state-node:hover {
            fill: var(--primary);
            filter: drop-shadow(0 4px 8px rgba(16, 185, 129, 0.3));
        }

        .state-text {
            font-size: 15px;
            font-weight: 600;
            fill: var(--text-primary);
            pointer-events: none;
            text-anchor: middle;
            font-family: 'Outfit', sans-serif;
        }

        .state-node:hover + .state-text {
            fill: white;
        }

        .transition-path {
            fill: none;
            stroke: var(--text-secondary);
            stroke-width: 2.5;
            marker-end: url(#arrowhead);
        }

        .transition-label {
            font-size: 13px;
            fill: var(--text-secondary);
            font-weight: 500;
            font-family: 'Fira Code', monospace;
        }

        /* Loading State */
        .loading {
            text-align: center;
        }

        .spinner {
            width: 64px;
            height: 64px;
            margin: 0 auto 1.5rem;
            border: 4px solid var(--bg-tertiary);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Error State */
        .error {
            background: #fef2f2;
            border: 2px solid #fecaca;
            border-left: 4px solid #dc2626;
            color: #991b1b;
            padding: 1.5rem;
            border-radius: 12px;
            font-weight: 500;
        }

        /* Footer */
        .footer {
            background: var(--bg-main);
            border-top: 1px solid var(--border);
            margin-top: 4rem;
            padding: 3rem 2rem 2rem;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .footer-content {
            max-width: 1600px;
            margin: 0 auto;
        }

        .footer-title {
            text-align: center;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .team-member {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .team-member:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            box-shadow: var(--shadow-lg);
        }

        .member-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .team-member:hover .member-icon {
            background: white;
        }

        .member-icon svg {
            width: 24px;
            height: 24px;
            stroke: white;
            transition: all 0.3s;
        }

        .team-member:hover .member-icon svg {
            stroke: var(--primary);
        }

        .member-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.5px;
            transition: all 0.3s;
        }

        .team-member:hover .member-name {
            color: white;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .footer-bottom a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }

        .footer-bottom a:hover {
            color: var(--primary-dark);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-wrapper {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .sidebar {
                position: relative;
                top: 0;
            }
        }

        @media (max-width: 768px) {
            .topbar {
                padding: 1rem;
            }

            .logo {
                font-size: 1.25rem;
            }

            .logo-icon {
                width: 32px;
                height: 32px;
            }

            .main-wrapper {
                padding: 0 1rem;
                margin: 1.5rem auto;
            }

            .sidebar,
            .output-card {
                padding: 1.5rem;
            }

            .info-banner {
                padding: 1.5rem;
            }

            .banner-title {
                font-size: 1.5rem;
            }

            .banner-subtitle {
                font-size: 1rem;
            }

            .output-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .team-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 1rem;
            }

            .footer {
                padding: 2rem 1rem 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .example-chips {
                gap: 0.375rem;
            }

            .example-chip {
                padding: 0.625rem 0.875rem;
                font-size: 0.8125rem;
            }

            .team-grid {
                grid-template-columns: 1fr;
            }

            .team-member {
                padding: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <!-- Topbar Navigation -->
    <nav class="topbar">
        <div class="topbar-content">
            <a href="/" class="logo">
                <svg class="logo-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="40" fill="url(#logo-gradient)"/>
                    <path d="M30 50 L50 30 L70 50 L50 70 Z" fill="white"/>
                    <defs>
                        <linearGradient id="logo-gradient" x1="0" y1="0" x2="100" y2="100">
                            <stop offset="0%" stop-color="#10b981"/>
                            <stop offset="100%" stop-color="#0ea5e9"/>
                        </linearGradient>
                    </defs>
                </svg>
                <span class="logo-text">FSM Designer</span>
            </a>
        </div>
    </nav>

    <!-- Main Wrapper -->
    <div class="main-wrapper">
        <!-- Sidebar Input Panel -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                </div>
                <h2 class="sidebar-title">Input Description</h2>
            </div>

            <div class="form-group">
                <label class="form-label">System Description</label>
                <textarea 
                    id="description" 
                    placeholder="Describe your finite state machine in natural language...&#10;&#10;Example: A traffic light that cycles through red, yellow, and green states with timer transitions."
                ></textarea>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="generateBtn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Generate
                </button>
            </div>

            <div class="examples-section">
                <div class="examples-header">Examples</div>
                <div class="example-chips" id="exampleChips"></div>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="content-area">
            <!-- Info Banner -->
            <div class="info-banner">
                <h1 class="banner-title">Finite State Machine Generator</h1>
                <p class="banner-subtitle">Transform natural language descriptions into visual state diagrams</p>
            </div>

            <!-- Output Card -->
            <div class="output-card">
                <div class="output-header">
                    <div class="output-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        State Diagram
                    </div>
                </div>

                <div class="output-body" id="outputContainer">
                    <div class="placeholder" id="placeholder">
                        <svg class="placeholder-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        <p class="placeholder-text">State diagram</p>
                    </div>

                    <div id="diagramContainer">
                        <svg id="diagram" viewBox="0 0 800 600"></svg>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <h3 class="footer-title">Project Team</h3>
            <div class="team-grid">
                <div class="team-member">
                    <div class="member-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <div class="member-name">TWINKLE SRIVASTWA</div>
                </div>
                <div class="team-member">
                    <div class="member-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <div class="member-name">DEBAPRIYA MONDAL</div>
                </div>
                <div class="team-member">
                    <div class="member-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <div class="member-name">SANGRAM KESHARI PATRA</div>
                </div>
                <div class="team-member">
                    <div class="member-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <div class="member-name">SUBHANKIT CHOUDHURY</div>
                </div>
                <div class="team-member">
                    <div class="member-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <div class="member-name">SOHAM CHOWDHURY</div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const descriptionInput = document.getElementById('description');
        const generateBtn = document.getElementById('generateBtn');
        const outputContainer = document.getElementById('outputContainer');
        const placeholder = document.getElementById('placeholder');
        const diagramContainer = document.getElementById('diagramContainer');
        const diagram = document.getElementById('diagram');
        const exampleChips = document.getElementById('exampleChips');

        const examples = [
            "A turnstile that unlocks when coin is inserted and locks after person passes through",
            "A washing machine cycles through idle, wash, rinse, and spin states",
            "A microwave starts heating when door closes and button pressed, stops when timer ends",
            "A fan operates at three speeds: low, medium, high, and can be turned off"
        ];

        // Populate examples
        examples.forEach(example => {
            const chip = document.createElement('div');
            chip.className = 'example-chip';
            chip.textContent = example;
            chip.onclick = () => {
                descriptionInput.value = example;
                descriptionInput.focus();
            };
            exampleChips.appendChild(chip);
        });

        // Parse FSM output
        function parseFSM(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            let states = [];
            let transitions = [];

            lines.forEach(line => {
                if (line.startsWith('states:')) {
                    const statesText = line.replace('states:', '').trim();
                    states = statesText.split(/[,|]/).map(s => s.trim()).filter(s => s);
                } else if (line.startsWith('transitions:')) {
                    const transText = line.replace('transitions:', '').trim();
                    const transList = transText.split(',').map(t => t.trim());
                    
                    transList.forEach(trans => {
                        const match = trans.match(/(\w+)\s*(?:--\s*([^-]+?)\s*-->|->)\s*(\w+)/);
                        if (match) {
                            const from = match[1];
                            const to = match[3];
                            const label = match[2] || '';
                            
                            transitions.push({
                                from: from,
                                to: to,
                                label: label.trim()
                            });
                        }
                    });
                }
            });

            return { states, transitions };
        }

        // Wrap text into multiple lines
        function wrapText(text, maxLength = 20) {
            if (text.length <= maxLength) return [text];
            
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            words.forEach(word => {
                if ((currentLine + ' ' + word).trim().length <= maxLength) {
                    currentLine += (currentLine ? ' ' : '') + word;
                } else {
                    if (currentLine) lines.push(currentLine);
                    currentLine = word;
                }
            });
            
            if (currentLine) lines.push(currentLine);
            return lines;
        }

        // Draw FSM diagram
        function drawDiagram(fsm) {
            const { states, transitions } = fsm;
            const width = 800;
            const height = 600;
            const nodeRadius = 50;
            const padding = 100;

            diagram.innerHTML = '';

            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead');
            marker.setAttribute('markerWidth', '10');
            marker.setAttribute('markerHeight', '10');
            marker.setAttribute('refX', '9');
            marker.setAttribute('refY', '3');
            marker.setAttribute('orient', 'auto');
            
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0 0, 10 3, 0 6');
            polygon.setAttribute('fill', '#475569');
            
            marker.appendChild(polygon);
            defs.appendChild(marker);
            diagram.appendChild(defs);

            const positions = {};
            const angleStep = (2 * Math.PI) / states.length;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width - padding * 2, height - padding * 2) / 2;

            states.forEach((state, i) => {
                const angle = i * angleStep - Math.PI / 2;
                positions[state] = {
                    x: centerX + radius * Math.cos(angle),
                    y: centerY + radius * Math.sin(angle)
                };
            });

            // Group transitions by from-to pair to handle multiple transitions
            const transitionGroups = {};
            transitions.forEach(trans => {
                const key = `${trans.from}-${trans.to}`;
                if (!transitionGroups[key]) {
                    transitionGroups[key] = [];
                }
                transitionGroups[key].push(trans);
            });

            // Draw transitions
            Object.entries(transitionGroups).forEach(([key, transGroup]) => {
                const trans = transGroup[0]; // Use first transition for positioning
                const from = positions[trans.from];
                const to = positions[trans.to];
                
                if (!from || !to) return;

                // Combine labels if multiple transitions between same states
                const combinedLabel = transGroup.map(t => t.label).filter(l => l).join(', ');

                if (trans.from === trans.to) {
                    // Self-loop
                    const loopSize = 70;
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const d = `M ${from.x},${from.y - nodeRadius} 
                              Q ${from.x - loopSize},${from.y - loopSize - nodeRadius} 
                              ${from.x},${from.y - nodeRadius}`;
                    path.setAttribute('d', d);
                    path.setAttribute('class', 'transition-path');
                    diagram.appendChild(path);

                    if (combinedLabel) {
                        const lines = wrapText(combinedLabel, 15);
                        const textGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                        
                        lines.forEach((line, idx) => {
                            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            label.setAttribute('x', from.x - loopSize / 2);
                            label.setAttribute('y', from.y - loopSize - nodeRadius - 5 - (lines.length - 1 - idx) * 14);
                            label.setAttribute('class', 'transition-label');
                            label.setAttribute('text-anchor', 'middle');
                            label.setAttribute('fill', '#475569');
                            label.textContent = line;
                            textGroup.appendChild(label);
                        });
                        
                        diagram.appendChild(textGroup);
                    }
                } else {
                    // Regular transition
                    const dx = to.x - from.x;
                    const dy = to.y - from.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    const fromX = from.x + (dx / dist) * nodeRadius;
                    const fromY = from.y + (dy / dist) * nodeRadius;
                    const toX = to.x - (dx / dist) * (nodeRadius + 10); // Offset for arrow
                    const toY = to.y - (dy / dist) * (nodeRadius + 10);

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', fromX);
                    line.setAttribute('y1', fromY);
                    line.setAttribute('x2', toX);
                    line.setAttribute('y2', toY);
                    line.setAttribute('class', 'transition-path');
                    diagram.appendChild(line);

                    if (combinedLabel) {
                        const lines = wrapText(combinedLabel, 20);
                        const textGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                        
                        // Calculate perpendicular offset for label
                        const midX = (fromX + toX) / 2;
                        const midY = (fromY + toY) / 2;
                        const perpX = -dy / dist;
                        const perpY = dx / dist;
                        const offset = 15;
                        
                        lines.forEach((line, idx) => {
                            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            const yOffset = (idx - (lines.length - 1) / 2) * 14;
                            label.setAttribute('x', midX + perpX * offset);
                            label.setAttribute('y', midY + perpY * offset + yOffset);
                            label.setAttribute('class', 'transition-label');
                            label.setAttribute('text-anchor', 'middle');
                            label.setAttribute('fill', '#475569');
                            
                            // Add white background for better readability
                            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                            const bbox = { width: line.length * 7, height: 14 };
                            bg.setAttribute('x', midX + perpX * offset - bbox.width / 2);
                            bg.setAttribute('y', midY + perpY * offset + yOffset - 10);
                            bg.setAttribute('width', bbox.width);
                            bg.setAttribute('height', bbox.height);
                            bg.setAttribute('fill', 'white');
                            bg.setAttribute('opacity', '0.85');
                            bg.setAttribute('rx', '4');
                            
                            textGroup.appendChild(bg);
                            
                            label.textContent = line;
                            textGroup.appendChild(label);
                        });
                        
                        diagram.appendChild(textGroup);
                    }
                }
            });

            // Draw states
            states.forEach(state => {
                const pos = positions[state];
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', pos.x);
                circle.setAttribute('cy', pos.y);
                circle.setAttribute('r', nodeRadius);
                circle.setAttribute('class', 'state-node');
                diagram.appendChild(circle);

                // Wrap state name if too long
                const stateLines = wrapText(state, 15);
                const textGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                
                stateLines.forEach((line, idx) => {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    const yOffset = (idx - (stateLines.length - 1) / 2) * 16;
                    text.setAttribute('x', pos.x);
                    text.setAttribute('y', pos.y + 6 + yOffset);
                    text.setAttribute('class', 'state-text');
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('fill', '#0f172a');
                    text.textContent = line;
                    textGroup.appendChild(text);
                });
                
                diagram.appendChild(textGroup);
            });
        }

        generateBtn.addEventListener('click', async () => {
            const description = descriptionInput.value.trim();

            if (!description) {
                alert('Please enter a description');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Generating...';
            
            placeholder.style.display = 'block';
            placeholder.innerHTML = '<div class="loading"><div class="spinner"></div><p class="loading-text">Generating your state diagram...</p></div>';
            
            diagramContainer.classList.remove('show');

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description }),
                });

                const data = await response.json();

                if (data.success) {
                    const fsm = parseFSM(data.output);
                    drawDiagram(fsm);
                    
                    placeholder.style.display = 'none';
                    diagramContainer.classList.add('show');
                } else {
                    placeholder.innerHTML = '<div class="error">Error: ' + data.error + '</div>';
                }
            } catch (error) {
                placeholder.innerHTML = '<div class="error">Network Error: ' + error.message + '</div>';
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>Generate';
            }
        });

        descriptionInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                generateBtn.click();
            }
        });
    </script>
</body>
</html>